version: '3.8'

services:
  # MongoDB
  mongo-db-fiware:
    image: mongo:4.4
    hostname: mongo-db-fiware
    container_name: mongo-db-fiware
    volumes:
      - ./volumes/mongo-db-fiware:/data/db
    restart: unless-stopped
    networks:
      - fiware-net

  # Orion Context Broker
  fiware-orion:
    image: fiware/orion
    hostname: fiware-orion
    container_name: fiware-orion
    depends_on:
      - mongo-db-fiware
    command: -dbURI mongodb://mongo-db-fiware:27017 -logLevel DEBUG
    restart: unless-stopped
    networks:
      - fiware-net

  # Grafana
  grafana:
    image: grafana/grafana
    container_name: grafana-fiware
    hostname: grafana-fiware
    environment:
      # Atualizado para seu domínio real
      - GF_SERVER_ROOT_URL=https://fiware-grafana.semarh.lan
    volumes:
      - ./volumes/grafana_storage:/var/lib/grafana
    user: '0'
    restart: unless-stopped
    networks:
      - fiware-net

  # IoT Agent JSON
  iot-agent-json:
    image: fiware/iotagent-json
    container_name: iot-agent-json
    hostname: iot-agent-json
    depends_on:
      - mongo-db-fiware
      - fiware-orion
    ports:
      # --- CORREÇÃO PARA DISPOSITIVOS IoT ---
      # Expõe a porta de dados HTTP (JSON) e a porta da API
      - "7896:7896"
      - "4041:4041"
    environment:
      - IOTA_CB_HOST=fiware-orion
      - IOTA_CB_PORT=1026
      - IOTA_NORTH_PORT=4041 # Porta da API (para NGINX)
      - IOTA_JSON_PORT=7896  # Porta de Dados (para dispositivos)
      - IOTA_REGISTRY_TYPE=mongodb
      - IOTA_LOG_LEVEL=DEBUG
      - IOTA_TIMESTAMP=true
      - IOTA_CB_NGSI_VERSION=v2
      - IOTA_MONGO_HOST=mongo-db-fiware
    restart: unless-stopped
    networks:
      - fiware-net

  # Keycloak
  keycloak-fiware:
    image: quay.io/keycloak/keycloak
    container_name: keycloak-fiware
    hostname: keycloak-fiware
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin123
      - KC_DB=dev-file
      - KC_PROXY=edge
      - KC_PROXY_HEADERS=xforwarded
      - KC_HTTP_ENABLED=true
      - KC_HTTP_PORT=8080
      - KC_HOSTNAME_STRICT=false
      # Atualizado para seu domínio real
      - KC_HOSTNAME=fiware-keycloak.semarh.lan
    command: start
    restart: unless-stopped
    networks:
      - fiware-net

  # CrateDB
  crate:
    image: crate/crate:latest
    container_name: crate-fiware
    hostname: crate-fiware
    command: ["crate", "-Cdiscovery.type=single-node"]
    volumes:
      - ./volumes/crate_data:/data
    restart: unless-stopped
    networks:
      - fiware-net

  # QuantumLeap
  quantumleap:
    image: orchestracities/quantumleap:latest
    container_name: quantumleap-fiware
    hostname: quantumleap-fiware
    depends_on:
      - crate
      - fiware-orion
    environment:
      - CRATE_HOST=crate-fiware
    restart: unless-stopped
    networks:
      - fiware-net

  # NGINX (Proxy Reverso)
  nginx-fiware:
    image: nginx
    container_name: nginx-fiware
    hostname: nginx-fiware
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certificate/fiware.crt:/etc/nginx/certificate/fiware.crt:ro
      - ./nginx/certificate/fiware.key:/etc/nginx/certificate/fiware.key:ro
    depends_on:
      - fiware-orion
      - iot-agent-json
      - quantumleap
      - grafana
      - keycloak-fiware
    networks:
      - fiware-net

networks:
  fiware-net:
    driver: bridge
